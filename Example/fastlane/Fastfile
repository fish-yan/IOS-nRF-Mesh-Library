# This file contains the fastlane.tools configuration
# You can find the documentation at https://docs.fastlane.tools
#
# For a list of all available actions, check out
#
#     https://docs.fastlane.tools/actions
#
# For a list of all available plugins, check out
#
#     https://docs.fastlane.tools/plugins/available-plugins
#

# Uncomment the line if you want fastlane to automatically update itself
# update_fastlane

default_platform(:ios)

platform :ios do
  
  scheme = "nRF Mesh"
  output_directory = "~/Desktop/ipa"
  output_name = "#{scheme}-#{Time.now.strftime("%Y-%m-%d %H:%M")}"
  pgy_api_key = "047c1f3a44a3b18d456c08ae8534c2dc"
  pgy_user_key = "67ba0b7c7d2fb4fee7953796db9fa8de"


  desc "ä¸Šä¼ ipa åˆ° pgy"
  lane :pgy do |options|
    #æ–¹æ³•è°ƒç”¨ï¼šfastlane uploadpgy config:"Debug"
    # ç¯å¢ƒç±»å‹
    configuration = "Debug" #options[:c] 
    changelog = options[:l]
    # if configuration["Debug"]
      method = "development"
    # else 
    #   method = "ad-hoc"
    # end
    package(config: configuration, method: method, devs: options[:d])
    puts "*************| å¼€å§‹ä¸Šä¼ åˆ°pgy... |*************"
    uploadpgy(desc: changelog)
    puts "*************| ä¸Šä¼ åˆ°pgyæˆåŠŸğŸ‰ |*************"
  end


  lane :package do |options|
    puts "*************| å¼€å§‹æ‰“åŒ…... |*************"
    increment_build_number(
      build_number: Time.now.strftime("%Y%m%d%H%M")
    )
    gym(
      scheme: scheme, #æ”¹ä¸ºä½ é¡¹ç›®çš„scheme
      workspace: "#{scheme}.xcworkspace", #å¦‚æœé¡¹ç›®ä½¿ç”¨CocoaPodséœ€è¦åŠ ä¸Š
      configuration: "#{options[:config]}", # Debug or Release
      output_directory: output_directory,
      output_name: output_name,
      silent: true,
      include_symbols: true,
      include_bitcode: false,
      export_method: options[:method],
    )
  end

  lane :uploadpgy do |options|
    #ä½¿ç”¨è‡ªåŠ¨è¯ä¹¦ç®¡ç†
    # update_code_signing_settings(
    #   use_automatic_signing: true,
    #   path: "#{scheme}.xcodeproj"
    # )
    
    # å¤šä¸ªå‚æ•° å¯ä»¥ä½¿ç”¨é€—å·(, )åˆ†ç¦»   
    pgyer(api_key: pgy_api_key, update_description: options[:desc])    
  end


end
